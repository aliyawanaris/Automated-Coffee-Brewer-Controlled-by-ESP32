<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mesin Penyeduh Kopi</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      header,
      footer {
        background-color: #2c3e50;
        color: white;
        text-align: center;
        padding: 1em;
      }

      main {
        flex: 1;
        display: flex;
        /* Menggunakan flex-wrap agar kartu bisa turun baris di layar kecil */
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        padding: 2em;
        background-color: #ecf0f1;
      }

      .card {
        background: white;
        padding: 2em;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
        text-align: center;
        margin: 1em; /* Menambahkan margin untuk memisahkan kartu jika ada banyak */
      }

      .value {
        font-size: 2em;
        margin: 0.5em 0;
        font-weight: bold; /* Menambahkan bold pada nilai */
      }

      /* Gaya untuk tombol relay */
      #relayButton {
        padding: 12px 25px;
        font-size: 18px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        color: white;
        margin-top: 1.5em; /* Memberi jarak dari elemen di atasnya */
        width: 80%; /* Membuat tombol sedikit lebih lebar */
        transition: background-color 0.3s ease; /* Efek transisi halus */
      }

      #relayButton.on {
        background-color: #28a745; /* Hijau untuk ON */
      }
      #relayButton.off {
        background-color: #dc3545; /* Merah untuk OFF */
      }
      #relayButton:hover {
        opacity: 0.9; /* Sedikit efek hover */
      }

      #relayStatus {
        font-weight: bold;
        color: #34495e; /* Warna default untuk status */
      }
      #relayStatus.on {
        color: green;
      }
      #relayStatus.off {
        color: red;
      }

      /* Gaya untuk RFID UID */
      #rfidUidDisplay {
        font-size: 1.5em; /* Lebih kecil sedikit dari value sensor lain agar muat */
        margin: 0.5em 0;
        color: #2c3e50;
        font-weight: bold;
        word-wrap: break-word; /* Memastikan UID panjang tidak merusak layout */
      }

      @media (max-width: 600px) {
        .card {
          padding: 1.2em;
        }
        .value {
          font-size: 1.5em;
        }
        #relayButton {
          font-size: 16px;
          padding: 10px 20px;
        }
        #rfidUidDisplay {
          font-size: 1.2em;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Mesin Penyeduh Kopi</h1>
    </header>

    <main>
      <div class="card">
        <h2>Data Real-Time</h2>
        <div>
          <strong>Kapasitas 1 (Biji Kopi):</strong>
          <div id="distance1" class="value">-- cm</div>
        </div>
        <div>
          <strong>Kapasitas 2 (Air Bersih):</strong>
          <div id="distance2" class="value">-- cm</div>
        </div>
        <div>
          <strong>Kapasitas 3 (Ampas Kopi):</strong>
          <div id="distance3" class="value">-- cm</div>
        </div>
        <div>
          <strong>Suhu:</strong>
          <div id="temperature" class="value">-- °C</div>
        </div>
        <!-- Tambahan: Layout untuk RFID UID -->
        <div>
          <strong>UID Kartu RFID:</strong>
          <div id="rfidUidDisplay" class="value">Belum Terbaca</div>
        </div>
        <!-------------------------------------->
        <div>
          <strong>Status Motor:</strong>
          <div id="relayStatus" class="value off">OFF</div>
        </div>
        <button id="relayButton" class="off">Nyalakan Motor</button>
      </div>
    </main>

    <footer>&copy; 2025 Mesin Penyeduh Kopi</footer>

    <script>
      // Dapatkan elemen untuk setiap sensor
      const distance1El = document.getElementById("distance1");
      const distance2El = document.getElementById("distance2");
      const distance3El = document.getElementById("distance3");
      const temperatureEl = document.getElementById("temperature");
      const rfidUidDisplayEl = document.getElementById("rfidUidDisplay"); // Dapatkan elemen untuk RFID UID
      const relayStatusEl = document.getElementById("relayStatus");
      const relayButton = document.getElementById("relayButton");

      const ws = new WebSocket(`ws://${location.hostname}/ws`);

      ws.onopen = () => {
        console.log("WebSocket Terhubung");
      };

      ws.onmessage = (event) => {
        // Parsing data yang diterima dari ESP32 (diasumsikan JSON)
        let data;
        try {
          data = JSON.parse(event.data);
          console.log("Data diterima:", data); // Untuk debugging
        } catch (e) {
          console.error(
            "Gagal mengurai JSON dari WebSocket:",
            e,
            "Data:",
            event.data
          );
          return; // Berhenti jika data bukan JSON yang valid
        }

        // --- PERUBAHAN DI SINI: Langsung akses properti JSON ---
        // Karena ESP32 mengirim JSON tanpa properti 'type', kita langsung akses data.

        // Perbarui elemen sensor jarak
        if (data.distance1 !== undefined) {
          distance1El.textContent = `${data.distance1} cm`;
        }
        if (data.distance2 !== undefined) {
          distance2El.textContent = `${data.distance2} cm`;
        }
        if (data.distance3 !== undefined) {
          distance3El.textContent = `${data.distance3} cm`;
        }

        // Perbarui status relay
        if (data.relayState !== undefined) {
          updateRelayStatus(data.relayState);
        }

        // Catatan: data 'temperature' dan 'rfidUid' belum dikirim oleh main.cpp saat ini.
        // Elemen HTMLnya akan tetap menampilkan nilai default sampai data tersebut ditambahkan di main.cpp.
        // Jika nanti Anda menambahkan DHT sensor, update kode main.cpp untuk mengirim 'temperature'
        // if (data.temperature !== undefined) {
        //     temperatureEl.textContent = `${data.temperature} °C`;
        // }
        // Jika nanti Anda menambahkan RFID reader, update kode main.cpp untuk mengirim 'uid'
        // if (data.uid !== undefined) { // Asumsi UID datang sebagai properti 'uid'
        //     rfidUidDisplayEl.textContent = data.uid;
        // }
      };

      ws.onclose = () => {
        console.log(
          "WebSocket Terputus. Mencoba menghubungkan kembali dalam 3 detik..."
        );
        setTimeout(() => {
          // Reconnect logic: Reload halaman untuk menyambung kembali WebSocket
          window.location.reload();
        }, 3000);
      };

      ws.onerror = (error) => {
        console.error("WebSocket Error:", error);
      };

      function updateRelayStatus(state) {
        // Karena ESP32 mengirim "true" atau "false" sebagai boolean (atau string), kita bandingkan
        if (state === true || state === "true") {
          // Handle both boolean true and string "true"
          // Relay ON (motor menyala)
          relayStatusEl.textContent = "ON";
          relayStatusEl.classList.remove("off");
          relayStatusEl.classList.add("on");
          relayButton.classList.remove("off");
          relayButton.classList.add("on");
          relayButton.textContent = "Matikan Motor";
        } else {
          // Relay OFF (motor mati)
          relayStatusEl.textContent = "OFF";
          relayStatusEl.classList.remove("on");
          relayStatusEl.classList.add("off");
          relayButton.classList.remove("on");
          relayButton.classList.add("off");
          relayButton.textContent = "Nyalakan Motor";
        }
      }

      relayButton.addEventListener("click", () => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send("toggleRelay");
        } else {
          console.warn(
            "WebSocket tidak terhubung. Tidak bisa mengirim perintah."
          );
        }
      });
    </script>
  </body>
</html>
